name: Bochs Emulator Test

on:
  push:
    branches: [ main, master, copilot/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          nasm \
          cmake \
          ninja-build \
          python3 \
          git \
          curl \
          xorg-dev \
          libx11-dev \
          libxrandr-dev \
          libgtk2.0-dev
    
    - name: Build and install Bochs with serial support
      run: |
        cd /tmp
        wget https://sourceforge.net/projects/bochs/files/bochs/2.7/bochs-2.7.tar.gz
        tar -xzf bochs-2.7.tar.gz
        cd bochs-2.7
        ./configure \
          --enable-cpu-level=6 \
          --enable-x86-64 \
          --enable-smp \
          --enable-svm \
          --enable-avx \
          --enable-long-phy-address \
          --enable-debugger \
          --enable-disasm \
          --enable-all-optimizations \
          --enable-pci \
          --enable-usb \
          --enable-usb-ohci \
          --enable-usb-ehci \
          --enable-usb-xhci \
          --enable-ne2000 \
          --enable-pnic \
          --enable-e1000 \
          --enable-raw-serial \
          --with-nogui
        make -j$(nproc)
        sudo make install
    
    - name: Build diskbuilder
      run: |
        cd External/diskbuilder
        mkdir -p build
        cd build
        cmake .. -G Ninja
        ninja
    
    - name: Build OS
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
    
    - name: Create headless bochsrc configuration
      run: |
        cat > bochs/bochsrc.ci <<'EOF'
        # Headless configuration for CI testing
        display_library: nogui
        
        # CPU configuration
        cpu: model=core2_penryn_t9600, count=1, ips=50000000, reset_on_triple_fault=1, ignore_bad_msrs=1
        cpuid: x86_64=1, mmx=1, sep=1, simd=sse4_2, apic=xapic, aes=1, movbe=1, xsave=1
        cpuid: family=6, model=0x1a, stepping=5, level=6
        
        # Memory
        memory: guest=4096, host=256
        
        # ROM images
        romimage: file=$BXSHARE/BIOS-bochs-latest
        vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest
        
        # PCI
        pci: enabled=1, chipset=i440fx
        
        # ATA controllers
        ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
        ata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15
        
        # Disk image
        ata0-master: type=disk, mode=flat, path=disk.img
        
        # Boot from disk
        boot: disk
        
        # Serial port for output capture
        com1: enabled=1, mode=file, dev=serial.out
        
        # Logging
        log: bochsout.txt
        debugger_log: -
        
        # Log levels
        panic: action=report
        error: action=report
        info: action=report
        debug: action=ignore
        
        # Magic breakpoint disabled for automated testing
        magic_break: enabled=0
        
        # Port E9 hack for debug output
        port_e9_hack: enabled=1
        
        # Mouse disabled for headless operation
        mouse: enabled=0
        
        # Private colormap
        private_colormap: enabled=0
        EOF
    
    - name: Run Bochs emulator
      timeout-minutes: 2
      run: |
        cd bochs
        # Copy disk image to bochs directory (it's created in repo root)
        if [ -f ../disk.img ]; then
          cp ../disk.img .
        elif [ -f ../build/disk.img ]; then
          cp ../build/disk.img .
        else
          echo "Error: disk.img not found!"
          ls -la ..
          ls -la ../build || true
          exit 1
        fi
        
        # Run bochs in headless mode with timeout
        # The OS should boot and produce serial output
        timeout 30s bochs -q -f bochsrc.ci || true
        
        echo "=== Bochs run completed ==="
        
        # Display bochs output log
        echo "=== Bochs Output Log ==="
        if [ -f bochsout.txt ]; then
          cat bochsout.txt
        else
          echo "No bochsout.txt found"
        fi
        
        echo ""
        echo "=== Serial Output ==="
        if [ -f serial.out ]; then
          cat serial.out
        else
          echo "No serial output found"
        fi
        
        echo ""
        echo "=== Port E9 Debug Output (from bochsout.txt) ==="
        if [ -f bochsout.txt ]; then
          grep -i "port 0x0e9" bochsout.txt || echo "No E9 output found"
        fi
    
    - name: Verify OS started
      run: |
        cd bochs
        
        # Check if we have any output indicating the OS started
        success=0
        
        # Check bochs log for successful boot indicators
        if [ -f bochsout.txt ]; then
          # Check if bochs started successfully
          if grep -q "Bochs x86 Emulator" bochsout.txt; then
            echo "✓ Bochs emulator started successfully"
            success=1
          fi
          
          # Check for boot sector execution
          if grep -q "Booting from" bochsout.txt; then
            echo "✓ Boot process initiated"
            success=1
          fi
        fi
        
        # Check serial output for any OS messages
        if [ -f serial.out ] && [ -s serial.out ]; then
          echo "✓ Serial output captured"
          echo "Serial output content:"
          cat serial.out
          success=1
        fi
        
        if [ $success -eq 0 ]; then
          echo "⚠ Warning: Could not verify OS boot, but Bochs ran without errors"
          echo "This may be normal if the OS doesn't produce serial output yet"
        fi
        
        # Don't fail the build, just report status
        exit 0
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bochs-output
        path: |
          bochs/bochsout.txt
          bochs/serial.out
          bochs/bochsrc.ci
        if-no-files-found: warn
