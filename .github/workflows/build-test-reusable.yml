name: Build and Test OS (Reusable)

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Name for the uploaded artifacts'
        required: false
        type: string
        default: 'bochs-output'
      upload-disk-image:
        description: 'Whether to upload disk.img as an artifact'
        required: false
        type: boolean
        default: false
    outputs:
      disk-image-path:
        description: 'Path to the disk image'
        value: ${{ jobs.build-and-test.outputs.disk-image-path }}
      serial-output-verified:
        description: 'Whether serial output was verified'
        value: ${{ jobs.build-and-test.outputs.serial-output-verified }}

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      disk-image-path: ${{ steps.set-outputs.outputs.disk-image-path }}
      serial-output-verified: ${{ steps.set-outputs.outputs.serial-output-verified }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          nasm \
          cmake \
          ninja-build \
          python3 \
          git \
          curl
    
    - name: Build and install Bochs with serial support
      run: |
        cd /tmp
        wget https://sourceforge.net/projects/bochs/files/bochs/2.7/bochs-2.7.tar.gz
        tar -xzf bochs-2.7.tar.gz
        cd bochs-2.7
        ./configure \
          --enable-cpu-level=6 \
          --enable-x86-64 \
          --enable-smp \
          --enable-svm \
          --enable-avx \
          --enable-long-phy-address \
          --enable-all-optimizations \
          --enable-pci \
          --enable-usb \
          --enable-usb-ohci \
          --enable-usb-ehci \
          --enable-usb-xhci \
          --enable-ne2000 \
          --enable-pnic \
          --enable-e1000 \
          --enable-raw-serial \
          --with-nogui
        make -j$(nproc)
        sudo make install
        
        # Clean up Bochs build artifacts
        cd /tmp
        rm -rf bochs-2.7 bochs-2.7.tar.gz
    
    - name: Build diskbuilder
      run: |
        cd External/diskbuilder
        mkdir -p build
        cd build
        cmake .. -G Ninja
        ninja
    
    - name: Build OS
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
    
    - name: Create headless bochsrc configuration
      run: |
        # Set BXSHARE environment variable for Bochs
        BXSHARE=/usr/local/share/bochs
        cat > bochs/bochsrc.ci <<EOF
        # Headless configuration for CI testing
        display_library: nogui
        
        # CPU configuration
        cpu: model=core2_penryn_t9600, count=1, ips=50000000, reset_on_triple_fault=1, ignore_bad_msrs=1
        cpuid: x86_64=1, mmx=1, sep=1, simd=sse4_2, apic=xapic, aes=1, movbe=1, xsave=1
        cpuid: family=6, model=0x1a, stepping=5, level=6
        
        # Memory
        memory: guest=4096, host=256
        
        # ROM images
        romimage: file=$BXSHARE/BIOS-bochs-latest
        vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest
        
        # PCI
        pci: enabled=1, chipset=i440fx
        
        # ATA controllers
        ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
        ata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15
        
        # Disk image
        ata0-master: type=disk, mode=flat, path=disk.img
        
        # Boot from disk
        boot: disk
        
        # Serial port for output capture
        com1: enabled=1, mode=file, dev=serial.out
        
        # Logging
        log: bochsout.txt
        debugger_log: -
        
        # Log levels
        panic: action=report
        error: action=report
        info: action=report
        debug: action=ignore
        
        # Magic breakpoint disabled for automated testing
        magic_break: enabled=0
        
        # Port E9 hack for debug output
        port_e9_hack: enabled=1
        
        # Mouse disabled for headless operation
        mouse: enabled=0
        
        # Private colormap
        private_colormap: enabled=0
        EOF
    
    - name: Run Bochs emulator
      timeout-minutes: 2
      run: |
        cd bochs
        # Copy disk image to bochs directory (it's created in repo root)
        if [ -f ../disk.img ]; then
          cp ../disk.img .
        else
          echo "Error: disk.img not found!"
          ls -la ..
          ls -la ../build || true
          exit 1
        fi
        
        # Set BXSHARE environment variable for Bochs
        export BXSHARE=/usr/local/share/bochs
        
        # Run bochs in headless mode with timeout
        # The OS should boot and produce serial output
        timeout 30s bochs -q -f bochsrc.ci || true
        
        echo "=== Bochs run completed ==="
    
    - name: Display Bochs output logs
      if: always()
      run: |
        cd bochs
        
        # Display bochs output log
        echo "=== Bochs Output Log ==="
        if [ -f bochsout.txt ]; then
          echo "File size: $(wc -c < bochsout.txt) bytes"
          cat bochsout.txt
        else
          echo "No bochsout.txt found"
        fi
        
        echo ""
        echo "=== Port E9 Debug Output (from bochsout.txt) ==="
        if [ -f bochsout.txt ]; then
          grep -i "port 0x0e9" bochsout.txt || echo "No E9 output found"
        fi
    
    - name: Dump Serial Output
      if: always()
      run: |
        cd bochs
        
        echo "========================================"
        echo "     SERIAL OUTPUT FROM COM1 PORT      "
        echo "========================================"
        echo ""
        
        if [ -f serial.out ]; then
          echo "Serial output file found!"
          echo "File size: $(wc -c < serial.out) bytes"
          echo "Line count: $(wc -l < serial.out) lines"
          echo ""
          echo "--- Serial Output Content ---"
          cat serial.out
          echo ""
          echo "--- End of Serial Output ---"
          
          # Also display as hex dump for verification
          if [ -s serial.out ]; then
            echo ""
            echo "--- Serial Output (Hex Dump - First 512 bytes) ---"
            xxd -l 512 serial.out || hexdump -C serial.out | head -32
          fi
        else
          echo "❌ No serial output file found!"
          echo "This means the OS did not write to the serial port."
        fi
        
        echo ""
        echo "Serial output capture location: $(pwd)/serial.out"
    
    - name: Verify OS started
      id: verify-os
      run: |
        cd bochs
        
        # Check if we have any output indicating the OS started
        success=0
        
        # Check bochs log for successful boot indicators
        if [ -f bochsout.txt ]; then
          # Check if bochs started successfully
          if grep -q "Bochs x86 Emulator" bochsout.txt; then
            echo "✓ Bochs emulator started successfully"
            success=1
          fi
          
          # Check for boot sector execution
          if grep -q "Booting from" bochsout.txt; then
            echo "✓ Boot process initiated"
            success=1
          fi
        fi
        
        # Check serial output for any OS messages
        if [ -f serial.out ] && [ -s serial.out ]; then
          echo "✓ Serial output captured"
          echo "Serial output content:"
          cat serial.out
          success=1
          echo "serial_verified=true" >> $GITHUB_OUTPUT
        else
          echo "serial_verified=false" >> $GITHUB_OUTPUT
        fi
        
        if [ $success -eq 0 ]; then
          echo "❌ ERROR: Could not verify OS boot - no serial output or boot indicators found"
          echo "The workflow expects either:"
          echo "  1. Serial output in serial.out, OR"
          echo "  2. Boot indicators in bochsout.txt (e.g., 'Booting from')"
          echo ""
          echo "Current status:"
          echo "  - Bochs log exists: $([ -f bochsout.txt ] && echo 'Yes' || echo 'No')"
          echo "  - Serial file exists: $([ -f serial.out ] && echo 'Yes' || echo 'No')"
          echo "  - Serial file size: $([ -f serial.out ] && wc -c < serial.out || echo '0') bytes"
          exit 1
        fi
        
        echo "✅ OS verification successful"
        exit 0
    
    - name: Set outputs
      id: set-outputs
      if: always()
      run: |
        echo "disk-image-path=disk.img" >> $GITHUB_OUTPUT
        # Use 'true' or 'false' as strings for consistency with GitHub Actions
        if [ "${{ steps.verify-os.outputs.serial_verified }}" = "true" ]; then
          echo "serial-output-verified=true" >> $GITHUB_OUTPUT
        else
          echo "serial-output-verified=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: |
          bochs/bochsout.txt
          bochs/serial.out
          bochs/bochsrc.ci
        if-no-files-found: warn
    
    - name: Upload disk image
      if: inputs.upload-disk-image && success()
      uses: actions/upload-artifact@v4
      with:
        name: disk-image
        path: disk.img
        if-no-files-found: error
    
    - name: Cleanup build artifacts
      if: always()
      run: |
        # Clean up temporary build directories
        rm -rf build/CMakeFiles
        rm -rf build/CMakeCache.txt
        rm -rf External/diskbuilder/build/CMakeFiles
        rm -rf External/diskbuilder/build/CMakeCache.txt
        
        # Clean up bochs test directory
        rm -rf bochs/bochsrc.ci bochs/bochsout.txt bochs/serial.out bochs/disk.img
